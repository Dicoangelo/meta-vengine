<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autonomous Session Analysis Dashboard</title>
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: #1a1f35;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --accent-cyan: #00d9ff;
            --accent-green: #00ff88;
            --accent-purple: #a78bfa;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 217, 255, 0.1);
        }

        .card h3 {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card .value {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            background: var(--bg-card);
            border-left: 3px solid var(--accent-cyan);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 8px;
        }

        .timeline-date {
            color: var(--accent-cyan);
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .timeline-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .timeline-content strong {
            color: var(--text-primary);
        }

        .timeline-content code {
            background: rgba(0, 217, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-cyan);
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
        }

        .refresh-btn {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green));
            color: var(--bg-primary);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            opacity: 0.9;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .status.operational {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .status.warning {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        td {
            color: var(--text-primary);
        }

        tr:hover {
            background: rgba(0, 217, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Autonomous Session Analysis</h1>
            <p>Real-time monitoring of the meta-learning engine</p>
            <div style="margin-top: 12px;">
                <span class="status operational">‚óè OPERATIONAL</span>
            </div>
        </div>

        <div style="display: flex; gap: 12px; margin-bottom: 20px; align-items: center;">
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>

            <label style="display: flex; align-items: center; gap: 8px; color: var(--text-primary); cursor: pointer;">
                <input type="checkbox" id="show-empty" onchange="applyFilters()"
                       style="width: 18px; height: 18px; cursor: pointer;">
                <span>Show empty sessions</span>
            </label>

            <div style="color: var(--text-secondary); font-size: 0.9rem;" id="filter-stats">
                <!-- Filter stats will be inserted here -->
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="grid">
            <div class="card">
                <h3>Total Sessions</h3>
                <div class="value" id="total-sessions">-</div>
                <div class="subtitle">Analyzed by multi-agent system</div>
            </div>

            <div class="card">
                <h3>Average Quality</h3>
                <div class="value" id="avg-quality">-</div>
                <div class="subtitle">Out of 5</div>
            </div>

            <div class="card">
                <h3>Avg Complexity</h3>
                <div class="value" id="avg-complexity">-</div>
                <div class="subtitle">Session complexity score</div>
            </div>

            <div class="card">
                <h3>Model Efficiency</h3>
                <div class="value" id="avg-efficiency">-</div>
                <div class="subtitle">Average routing efficiency</div>
            </div>

            <div class="card">
                <h3>Empty Sessions</h3>
                <div class="value" id="empty-sessions-count">-</div>
                <div class="subtitle" id="empty-sessions-pct">-</div>
            </div>
        </div>

        <!-- Outcome Distribution -->
        <div class="section">
            <h2>üìä Session Outcomes</h2>
            <div class="chart-container">
                <table id="outcomes-table">
                    <thead>
                        <tr>
                            <th>Outcome</th>
                            <th>Count</th>
                            <th>Percentage</th>
                        </tr>
                    </thead>
                    <tbody id="outcomes-body">
                        <tr><td colspan="3" style="text-align:center;color:var(--text-secondary);">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Feedback Loop Actions -->
        <div class="section">
            <h2>üîÑ Feedback Loop Actions</h2>
            <div class="chart-container" id="feedback-actions">
                <p style="color:var(--text-secondary);">Loading baseline updates...</p>
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="section">
            <h2>üìù Recent Sessions</h2>
            <div class="chart-container">
                <table>
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Title</th>
                            <th>Intent</th>
                            <th>Outcome</th>
                            <th>Quality</th>
                            <th>Complexity</th>
                            <th>Efficiency</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table">
                        <tr><td colspan="7" style="text-align:center;color:var(--text-secondary);">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let allSessions = [];
        let filteredSessions = [];

        function isEmptySession(session) {
            // A session is "empty" if it was just started and closed with no real work
            return (
                session.outcome === 'abandoned' &&
                session.quality === 1 &&
                (!session.files_modified || session.files_modified.length === 0)
            );
        }

        function applyFilters() {
            const showEmpty = document.getElementById('show-empty').checked;

            if (showEmpty) {
                filteredSessions = allSessions;
            } else {
                filteredSessions = allSessions.filter(s => !isEmptySession(s));
            }

            const emptyCount = allSessions.length - filteredSessions.length;
            const filterStats = document.getElementById('filter-stats');
            filterStats.textContent = showEmpty
                ? `Showing all ${allSessions.length} sessions`
                : `Hiding ${emptyCount} empty sessions (${filteredSessions.length} shown)`;

            // Re-render with filtered data
            renderDashboard();
        }

        function renderDashboard() {
            const sessions = filteredSessions;
            const totalSessions = sessions.length;
            const emptyCount = allSessions.filter(s => isEmptySession(s)).length;
            const emptyPct = allSessions.length > 0 ? (emptyCount / allSessions.length * 100).toFixed(1) : 0;

            // Update empty sessions card
            document.getElementById('empty-sessions-count').textContent = emptyCount;
            document.getElementById('empty-sessions-pct').textContent = `${emptyPct}% of all sessions`;

            if (totalSessions === 0) {
                document.getElementById('total-sessions').textContent = '0';
                document.getElementById('avg-quality').textContent = '-';
                document.getElementById('avg-complexity').textContent = '-';
                document.getElementById('avg-efficiency').textContent = '-';
                return;
            }

            // Calculate metrics
            const avgQuality = (sessions.reduce((sum, s) => sum + (s.quality || 0), 0) / totalSessions).toFixed(2);
            const avgComplexity = (sessions.reduce((sum, s) => sum + (s.complexity || 0), 0) / totalSessions).toFixed(2);
            const avgEfficiency = (sessions.reduce((sum, s) => sum + (s.model_efficiency || 0), 0) / totalSessions * 100).toFixed(1);

            // Update key metrics (filtered)
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('avg-quality').textContent = avgQuality;
            document.getElementById('avg-complexity').textContent = avgComplexity;
            document.getElementById('avg-efficiency').textContent = avgEfficiency + '%';

            // Outcome distribution
            const outcomes = {};
            sessions.forEach(s => {
                const outcome = s.outcome || 'unknown';
                outcomes[outcome] = (outcomes[outcome] || 0) + 1;
            });

            const outcomesBody = document.getElementById('outcomes-body');
            outcomesBody.innerHTML = Object.entries(outcomes)
                .sort((a, b) => b[1] - a[1])
                .map(([outcome, count]) => {
                    const percentage = (count / totalSessions * 100).toFixed(1);
                    return `
                        <tr>
                            <td style="text-transform:capitalize">${outcome}</td>
                            <td>${count}</td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                }).join('');

            // Recent sessions (last 10)
            const recentSessions = sessions.slice(-10).reverse();
            const sessionsTable = document.getElementById('sessions-table');
            sessionsTable.innerHTML = recentSessions.map(s => {
                const title = s.title || 'No title';
                const titleShort = title.length > 40 ? title.substring(0, 37) + '...' : title;
                const intent = s.intent || 'Unknown';
                const intentShort = intent.length > 30 ? intent.substring(0, 27) + '...' : intent;
                const summary = s.summary_text || 'No summary available';

                return `
                    <tr title="üìù ${summary}" style="cursor: help;">
                        <td style="font-family:monospace;font-size:0.85rem">${s.session_id.substring(0, 8)}...</td>
                        <td style="font-size:0.9rem">${titleShort}</td>
                        <td style="font-size:0.85rem;color:var(--text-secondary)">${intentShort}</td>
                        <td style="text-transform:capitalize">${s.outcome || 'unknown'}</td>
                        <td>${s.quality || '-'}</td>
                        <td>${s.complexity ? s.complexity.toFixed(2) : '-'}</td>
                        <td>${s.model_efficiency ? (s.model_efficiency * 100).toFixed(0) + '%' : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadData() {
            try {
                // Load sessions from API
                const response = await fetch('/api/sessions');
                const allEvents = await response.json();

                // Filter for only session_analysis_complete events
                const analysisEvents = allEvents.filter(e => e.event === 'session_analysis_complete');

                // Keep only the LATEST analysis for each unique session_id
                const sessionMap = new Map();
                analysisEvents.forEach(event => {
                    const sessionId = event.session_id;
                    const timestamp = event.ts || 0;

                    // If we haven't seen this session, or this event is newer, keep it
                    if (!sessionMap.has(sessionId) || timestamp > sessionMap.get(sessionId).ts) {
                        sessionMap.set(sessionId, event);
                    }
                });

                // Convert back to array
                allSessions = Array.from(sessionMap.values());

                // Apply filters (default: hide empty sessions)
                applyFilters();

                // Load feedback loop actions (if available)
                await loadFeedbackActions();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('total-sessions').textContent = 'Error';
                alert('Could not load session data. Make sure session-outcomes.jsonl exists.');
            }
        }

        async function loadFeedbackActions() {
            try {
                const response = await fetch('/api/baselines');
                const baselines = await response.json();

                if (baselines.feedback_lineage && baselines.feedback_lineage.length > 0) {
                    const feedbackDiv = document.getElementById('feedback-actions');
                    feedbackDiv.innerHTML = `
                        <div class="timeline">
                            ${baselines.feedback_lineage.slice(-5).reverse().map(update => `
                                <div class="timeline-item">
                                    <div class="timeline-date">${new Date(update.applied).toLocaleDateString()}</div>
                                    <div class="timeline-content">
                                        <strong>${update.update_id}</strong>: ${update.rationale}<br/>
                                        <code>${update.parameter}: ${update.old_value.toFixed(3)} ‚Üí ${update.new_value.toFixed(3)}</code><br/>
                                        Confidence: ${(update.confidence * 100).toFixed(0)}% (${update.samples} sessions)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    document.getElementById('feedback-actions').innerHTML = `
                        <p style="color:var(--text-secondary);">No feedback loop updates yet. System is collecting data.</p>
                    `;
                }
            } catch (error) {
                document.getElementById('feedback-actions').innerHTML = `
                    <p style="color:var(--text-secondary);">Feedback loop data not available yet.</p>
                `;
            }
        }

        // Load data on page load
        loadData();

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
